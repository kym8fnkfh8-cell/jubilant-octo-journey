<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OSRS Skilling Planner â€” v4.3g</title>
<meta name="theme-color" content="#0b0d12" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="favicon.png">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
:root{--bg:#0b0d12;--stone:#141824;--stone2:#0f1320;--edge:#2a2f45;--text:#f0f3f9;--muted:#9aa3b2;--gold:#e6c36a;--gold2:#ffdb7d;--accent:#8ab4f8}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
.wrap{max-width:1080px;margin:18px auto 80px;padding:0 14px}
header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
h1{font-size:20px;color:var(--gold);margin:0;text-shadow:0 1px 0 #433,0 0 6px rgba(230,195,106,.15)}
.btn{border:1px solid #463a1a;background:linear-gradient(180deg,#e6c36a,#caa64f);color:#1a1208;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
.btn:hover{filter:brightness(1.05)}.btn.outline{background:transparent;color:var(--gold);border-color:#5a4a1f}
.card{background:linear-gradient(180deg,var(--stone),var(--stone2));border:1px solid var(--edge);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.span-3{grid-column:span 3}.span-4{grid-column:span 4}.span-6{grid-column:span 6}.span-8{grid-column:span 8}.span-12{grid-column:1/-1}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select{width:100%;background:#0c1019;border:1px solid #2a2f45;color:var(--text);padding:10px 12px;border-radius:9px}
.kpi{display:flex;flex-direction:column;gap:4px;padding:10px 12px;border-radius:10px;background:#0e1220;border:1px solid #23283a}
.kpi .big{font-weight:800;font-size:22px;color:var(--gold2)}
.progress{height:12px;border-radius:999px;border:1px solid #2a2f45;background:#0d111b;overflow:hidden}
.progress>div{height:100%;width:0;background:linear-gradient(90deg,#24c8a8,#5fb3ff)}
.week-wrap{overflow-x:auto;padding-bottom:6px}
.week{display:grid;gap:12px;grid-template-columns:repeat(7,minmax(140px,1fr))}
.day{background:#0f1320;border:1px solid #23283a;border-radius:10px;padding:10px}
.day h4{margin:0 0 6px;font-size:13px;color:#c2c9d6}
input[type=range]{width:100%;background:transparent}
.footer{text-align:center;font-size:12px;color:#98a1b3;margin:30px 0 10px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #2a2f45;background:#111522;font-size:12px;color:var(--muted)}
.skill-picker{position:relative}
.skill-btn{width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #2a2f45;border-radius:9px;background:#0c1019;color:var(--text);cursor:pointer}
.skill-btn img{width:22px;height:22px;border-radius:4px}
.skill-panel{position:absolute;z-index:50;left:0;width:min(620px,96vw);margin-top:6px;background:#0f1320;border:1px solid #23283a;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:none;max-height:70vh;overflow-y:auto;padding:12px}
.skill-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
.skill-item{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #23283a;border-radius:8px;background:#0e1220;cursor:pointer}
.skill-item:hover{background:#10162a}
#splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0b0d12;z-index:999}
.fade-out{animation:fadeout .45s ease forwards}@keyframes fadeout{to{opacity:0;transform:translateY(6px)}}
</style>
</head>
<body>
<div id="splash"><h1 style="color:var(--gold)">Loadingâ€¦</h1></div>

<div class="wrap" id="appRoot" style="visibility:hidden">
<header>
  <h1>OSRS Skilling Planner <small>v4.3g</small></h1>
  <div class="row">
    <button id="saveBtn"  class="btn outline">Save</button>
    <button id="loadBtn"  class="btn outline">Load</button>
    <button id="resetBtn" class="btn outline">Reset</button>
    <button id="exportBtn" class="btn outline">Export</button>
    <input id="importInput" type="file" accept=".json" style="display:none" />
    <button id="importBtn" class="btn outline">Import</button>
    <button id="addWeekBtn" class="btn">+ Add Week</button>
  </div>
</header>

<div class="card grid">
  <div class="span-4"><label>RuneScape name</label><input id="rsn" type="text" value="D 3VI L"></div>
  <div class="span-4"><label>Hiscore type</label>
    <select id="mode">
      <option value="hiscore_oldschool">Normal</option>
      <option value="hiscore_oldschool_ironman">Ironman</option>
      <option value="hiscore_oldschool_ultimate">Ultimate</option>
      <option value="hiscore_oldschool_hardcore_ironman">Hardcore</option>
    </select>
  </div>
  <div class="span-4"><label>&nbsp;</label><button id="fetchBtn" class="btn">Fetch Hiscores</button></div>

  <div class="span-12 card" style="border-color:#4a3b1a">
    <div class="pill">ðŸŽ¯ Goal setup</div>
    <div class="grid" style="margin-top:10px">
      <div class="span-4">
        <label>Skill</label>
        <div class="skill-picker" id="skillPicker">
          <button type="button" id="skillBtn" class="skill-btn">
            <img id="skillIcon" src="assets/skills/fishing.png"><span id="skillLabel">Fishing</span>
          </button>
          <div class="skill-panel" id="skillPanel"></div>
        </div>
      </div>
      <div class="span-4"><label>Target level</label><select id="targetLevel"></select></div>
      <div class="span-4"><label>XP/hr</label><input id="xpPerHour" type="number" value="90000"></div>

      <div class="span-3"><label>Current level</label><div class="kpi"><span class="big" id="curLevel">â€”</span><span class="muted">from hiscores</span></div></div>
      <div class="span-3"><label>Current XP</label><div class="kpi"><span class="big" id="curXp">â€”</span><span class="muted">from hiscores</span></div></div>
      <div class="span-3"><label>Target XP</label><div class="kpi"><span class="big" id="tgtXp">â€”</span><span class="muted">calc from level</span></div></div>
      <div class="span-3"><label>XP to goal</label><div class="kpi"><span class="big" id="xpRemainingKpi">â€”</span><span class="muted">tgt - current</span></div></div>

      <div class="span-12"><div class="progress"><div id="progressFill"></div></div></div>
    </div>
  </div>

  <div class="span-12" style="display:flex;gap:12px;flex-wrap:wrap">
    <div class="kpi"><span class="muted">Hours needed</span><span id="hoursNeeded" class="big">0</span></div>
    <div class="kpi"><span class="muted">Hours allocated (all weeks)</span><span id="hoursAllocated" class="big">0</span></div>
    <div class="kpi"><span class="muted">Hours remaining</span><span id="hoursRemaining" class="big">0</span></div>
    <div class="kpi"><span class="muted">Projected finish (est.)</span><span id="eta" class="big">â€”</span></div>
  </div>
</div>

<div id="weeks"></div>

<footer class="footer">
  Old School RuneScape assets Â© Jagex Ltd â€” used under Jagexâ€™s
  <a href="https://www.jagex.com/en-GB/terms/fan-content-policy" target="_blank">Fan Content Policy</a>.
</footer>
</div>

<script>
(function(){
/* ---------- XP table ---------- */
const XP = (() => { const xp = Array(127).fill(0); let p=0; for(let L=1; L<=126; L++){ p += Math.floor(L + 300*Math.pow(2,L/7)); xp[L] = Math.floor(p/4); } return xp; })();

/* ---------- Skills (key order matches OSRS hiscores block) ---------- */
const SK = [
 {k:"attack"},{k:"defence"},{k:"strength"},{k:"hitpoints"},{k:"ranged"},{k:"prayer"},{k:"magic"},{k:"cooking"},
 {k:"woodcutting"},{k:"fletching"},{k:"fishing"},{k:"firemaking"},{k:"crafting"},{k:"smithing"},{k:"mining"},
 {k:"herblore"},{k:"agility"},{k:"thieving"},{k:"slayer"},{k:"farming"},{k:"runecraft"},{k:"hunter"},{k:"construction"}
];

/* ---------- Dom refs ---------- */
const root = document.getElementById("appRoot");
const splash = document.getElementById("splash");
const rsnEl  = document.getElementById("rsn");
const modeEl = document.getElementById("mode");
const fetchBtn = document.getElementById("fetchBtn");
const skillBtn = document.getElementById("skillBtn");
const skillPanel = document.getElementById("skillPanel");
const skillIcon = document.getElementById("skillIcon");
const skillLabel= document.getElementById("skillLabel");
const targetSel = document.getElementById("targetLevel");
const xpPerHourEl = document.getElementById("xpPerHour");

const curLevelEl = document.getElementById("curLevel");
const curXpEl    = document.getElementById("curXp");
const tgtXpEl    = document.getElementById("tgtXp");
const xpRemEl    = document.getElementById("xpRemainingKpi");
const progressFill = document.getElementById("progressFill");

const hoursNeededEl = document.getElementById("hoursNeeded");
const hoursAllocEl  = document.getElementById("hoursAllocated");
const hoursRemEl    = document.getElementById("hoursRemaining");
const etaEl         = document.getElementById("eta");
const weeksEl       = document.getElementById("weeks");

const MAX_HOURS_PER_DAY = 24;

/* ---------- Splash ---------- */
function hideSplash(){ splash.classList.add("fade-out"); setTimeout(()=>splash.remove(),600); root.style.visibility="visible"; }
window.addEventListener("load", hideSplash);

/* ---------- State ---------- */
let state = {
  rsn: rsnEl.value || "",
  mode: modeEl.value,
  skillIdx: 11,        // default Fishing
  skillKey: "fishing",
  targetLevel: 91,
  xpPerHour: 90000,
  hiscores: null,
  weeks: [Array(7).fill(0)]
};

/* ---------- UI builders ---------- */
for(let L=1; L<=126; L++){ const o=document.createElement("option"); o.value=L; o.textContent=L; if(L===state.targetLevel) o.selected=true; targetSel.appendChild(o); }

(function buildSkillPanel(){
  const grid = document.createElement("div"); grid.className="skill-grid";
  SK.forEach((s,idx)=>{
    const item=document.createElement("div"); item.className="skill-item";
    const img=document.createElement("img"); img.src="assets/skills/"+s.k+".png"; img.alt=s.k;
    const span=document.createElement("span"); span.textContent=s.k[0].toUpperCase()+s.k.slice(1);
    item.append(img,span);
    item.onclick=()=>{ state.skillIdx=idx+1; state.skillKey=s.k; skillIcon.src=img.src; skillLabel.textContent=span.textContent; updateKpis(); skillPanel.style.display="none"; };
    grid.appendChild(item);
  });
  skillPanel.appendChild(grid);
  skillBtn.onclick=()=>skillPanel.style.display = (skillPanel.style.display==='block')?'none':'block';
  window.addEventListener('click', (e)=>{ if(!document.getElementById('skillPicker').contains(e.target)) skillPanel.style.display='none'; });
})();

/* ---------- Weeks ---------- */
function weekCard(i){
  const hours = state.weeks[i];
  return `<div class="card" data-week="${i}">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="pill">Week ${i+1}</div>
      <div>
        <button class="btn outline" data-act="dup">Duplicate</button>
        <button class="btn outline" data-act="clear">Clear</button>
        <button class="btn outline" data-act="del">Delete</button>
      </div>
    </div>
    <div class="week-wrap"><div class="week">
      ${["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map((d,idx)=>`
        <div class="day">
          <h4>${d}</h4>
          <input type="range" min="0" max="${MAX_HOURS_PER_DAY}" step="0.25" value="${hours[idx]||0}" data-day="${idx}">
          <div style="display:flex;gap:8px;align-items:center"><span class="muted">Hours</span>
            <input class="hr" type="number" min="0" max="${MAX_HOURS_PER_DAY}" step="0.25" value="${hours[idx]||0}" data-day="${idx}">
          </div>
        </div>`).join("")}
    </div></div>
  </div>`;
}
function mountWeeks(){ weeksEl.innerHTML = state.weeks.map((_,i)=>weekCard(i)).join(""); }
function ensureWeek(){ if(!state.weeks.length) state.weeks.push(Array(7).fill(0)); }
weeksEl.addEventListener("input",(e)=>{
  const card=e.target.closest("[data-week]"); if(!card) return;
  const w=+card.getAttribute("data-week"); const d=+e.target.getAttribute("data-day");
  const val=Math.max(0, Math.min(MAX_HOURS_PER_DAY, Number(e.target.value)||0));
  state.weeks[w][d]=val;
  card.querySelectorAll(`[data-day="${d}"]`).forEach(n=>{ if(n!==e.target) n.value=val; });
  updateKpis();
});
weeksEl.addEventListener("click",(e)=>{
  const btn=e.target.closest("button[data-act]"); if(!btn) return;
  const w=+e.target.closest("[data-week]").getAttribute("data-week");
  const act=btn.getAttribute("data-act");
  if(act==="dup") state.weeks.push([...(state.weeks[w]||Array(7).fill(0))]);
  if(act==="clear") state.weeks[w]=Array(7).fill(0);
  if(act==="del") state.weeks.splice(w,1);
  ensureWeek(); mountWeeks(); updateKpis();
});

/* ---------- Hiscores ---------- */
async function fetchHiscores(rsn, mode){
  const base = `https://secure.runescape.com/m=${mode}/index_lite.ws?player=${encodeURIComponent(rsn)}`;
  const url  = `https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`;
  const res  = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  const lines = text.trim().split(/\r?\n/);
  const stats={};
  for(let i=0;i<lines.length;i++){
    const p=lines[i].split(","); if(p.length<3) continue;
    stats[i]={rank:+p[0]||-1, level:+p[1]||0, xp:+p[2]||0};
  }
  return stats;
}
fetchBtn.onclick = async ()=>{
  const rsn = rsnEl.value.trim(); if(!rsn) return alert("Enter RSN first");
  try{
    state.hiscores = await fetchHiscores(rsn, modeEl.value);
    const cur = state.hiscores[state.skillIdx] || {level:1,xp:0};
    curLevelEl.textContent = cur.level; curXpEl.textContent = cur.xp.toLocaleString();
    updateKpis();
  }catch(e){ alert("Hiscore fetch failed: "+e.message); }
};

/* ---------- Math / KPIs ---------- */
function ceil2(n){ return Math.ceil(n*100)/100 }
function sumAllocated(){ return ceil2(state.weeks.flat().reduce((a,b)=>a+(+b||0),0)); }
function updateKpis(){
  const cur=(state.hiscores && state.hiscores[state.skillIdx])?state.hiscores[state.skillIdx]:{level:1,xp:0};
  curLevelEl.textContent=cur.level||1;
  curXpEl.textContent=(cur.xp||0).toLocaleString();

  state.targetLevel = +targetSel.value || state.targetLevel;
  state.xpPerHour   = +xpPerHourEl.value || state.xpPerHour;

// Target level & target XP (one definition)
const tgtLevel = Number(targetSel.value || state.targetLevel || 1);
const tgtXp    = XP[tgtLevel] || 0;
tgtXpEl.textContent = tgtXp.toLocaleString();

// ----- XP to goal (friendly + exact) -----
const curLevel = cur.level || 1;
const curXp    = cur.xp || 0;

// shortfall to the *exact* threshold of the chosen level
const shortfall = Math.max(0, tgtXp - curXp);

// Friendly rule:
// if you've selected a level you already have (or lower), show 0,
// but still surface the shortfall in a small note.
let xpRemaining = (tgtLevel <= curLevel) ? 0 : shortfall;
xpRemEl.textContent = xpRemaining.toLocaleString();

// Optional note: show true XP gap if you're below threshold of that level
let note = document.getElementById('thresholdNote');
if (!note) {
  note = document.createElement('div');
  note.id = 'thresholdNote';
  note.style.fontSize = '12px';
  note.style.color = '#9aa3b2';
  note.style.marginTop = '4px';
  xpRemEl.parentElement.parentElement.appendChild(note);
}
note.textContent = (tgtLevel <= curLevel && shortfall > 0)
  ? `Below level threshold by ${shortfall.toLocaleString()} XP (exact).`
  : '';

  const hoursNeeded = xpRemaining<=0 ? 0 : ceil2(xpRemaining / Math.max(1,state.xpPerHour));
  const allocated   = sumAllocated();
  const remaining   = Math.max(0, ceil2(hoursNeeded - allocated));
  hoursNeededEl.textContent = hoursNeeded.toFixed(hoursNeeded%1?2:0);
  hoursAllocEl.textContent  = allocated.toFixed(allocated%1?2:0);
  hoursRemEl.textContent    = remaining.toFixed(remaining%1?2:0);

  const pct = hoursNeeded>0 ? Math.min(100, Math.max(0,(allocated/hoursNeeded)*100)) : 0;
  progressFill.style.width = pct + "%";
  etaEl.textContent = "â€”"; // simple version (date projection can be added later)

  try{ localStorage.setItem("osrs_plan_v43g", JSON.stringify(state)); }catch{}
}
targetSel.onchange = updateKpis;
xpPerHourEl.oninput = updateKpis;

/* ---------- Save/Load/Export/Import/Reset ---------- */
document.getElementById("saveBtn").onclick = ()=>{ try{ localStorage.setItem("osrs_plan_v43g", JSON.stringify(state)); alert("Saved."); }catch(e){ alert("Save failed: "+e.message); } };
document.getElementById("loadBtn").onclick = ()=>{ try{ const s=localStorage.getItem("osrs_plan_v43g"); if(s){ state=JSON.parse(s); mountWeeks(); updateKpis(); alert("Loaded."); } else alert("No save yet."); }catch(e){ alert("Load failed: "+e.message); } };
document.getElementById("resetBtn").onclick= ()=>{ if(confirm("Reset plan?")){ state.weeks=[Array(7).fill(0)]; mountWeeks(); updateKpis(); } };
document.getElementById("exportBtn").onclick= ()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="osrs_skilling_plan.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); };
document.getElementById("importBtn").onclick= ()=> document.getElementById("importInput").click();
document.getElementById("importInput").onchange = (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ state=JSON.parse(r.result); mountWeeks(); updateKpis(); alert("Imported."); }catch(err){ alert("Import failed: "+err.message); } }; r.readAsText(f); };

/* ---------- Init ---------- */
try{ const s=localStorage.getItem("osrs_plan_v43g"); if(s) state=JSON.parse(s); }catch{}
mountWeeks(); updateKpis();
})();
</script>

<script>
if('serviceWorker' in navigator && !location.search.includes('no-sw=1')){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js').catch(()=>{}));
}
</script>
</body>
</html>
